!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var Widget,addWidget,bail,contentEl,deserialize,getScreens,getWidgets,handleBrokenWidget,hideWidget,init,initWidget,initWidgets,isMainScreen,isVisibleOnScreen,listen,logError,pinWidget,reRenderWidgets,removeWidget,renderWidget,screenId,screens,unHideWidget,unPinWidget,updateWidget,widgets;Widget=require("./src/widget.coffee"),listen=require("./src/listen"),widgets={},screens=[],contentEl=null,screenId=null,init=function(){return screenId=Number(window.location.pathname.replace(/\//g,"")),window.uebersicht=require("./src/os_bridge.coffee"),contentEl=document.getElementById("__uebersicht"),contentEl.innerHTML="",window.addEventListener("onwallpaperchange",function(){return contentEl.style.transform="translateZ(1px)",requestAnimationFrame(function(){return contentEl.style.transform=""})}),window.addEventListener("contextmenu",function(e){return e.preventDefault()}),widgets={},screens=[],getScreens(function(err,data){return null!=err&&console.log(err),null!=err?setTimeout(bail,1e4):(screens=data.screens,getWidgets(function(err,widgetSettings){return null!=err&&console.log(err),null!=err?setTimeout(bail,1e4):(initWidgets(widgetSettings),listen("WIDGET_ADDED",function(details){return initWidget(details)}),listen("WIDGET_REMOVED",function(id){return removeWidget(id)}),listen("WIDGET_UPDATED",function(details){return updateWidget(details)}),listen("WIDGET_BROKE",function(details){return handleBrokenWidget(details.id,details)}),listen("WIDGET_DID_UNHIDE",function(id){return unHideWidget(widgets[id])}),listen("WIDGET_WAS_PINNED",function(id){return pinWidget(widgets[id])}),listen("WIDGET_WAS_UNPINNED",function(id){return unPinWidget(widgets[id])}),listen("WIDGET_DID_CHANGE_SCREEN",function(d){return widgets[d.id].settings.screenId=d.screenId,reRenderWidgets()}),listen("SCREENS_DID_CHANGE",function(newScreens){return screens=newScreens}))}))})},getScreens=function(callback){return $.get("/screens/").done(function(response){return callback(null,JSON.parse(response))}).fail(function(){return callback(response,null)})},getWidgets=function(callback){return $.get("/widgets/").done(function(response){return callback(null,JSON.parse(response))}).fail(function(){return callback(response,null)})},initWidgets=function(widgetSettings){var _,details,results;results=[];for(_ in widgetSettings)details=widgetSettings[_],results.push(initWidget(details));return results},initWidget=function(details){return addWidget(details),details.error?handleBrokenWidget(details.id,details.error):(details.instance=Widget(deserialize(details.body)),isVisibleOnScreen(details,screenId)?renderWidget(details):void 0)},addWidget=function(details){return widgets[details.id]?widgets[details.id]:(widgets[details.id]=details,details)},removeWidget=function(id){return widgets[id]?(widgets[id].instance.destroy(),widgets[id]=void 0):void 0},updateWidget=function(updates){var ref,widget;return(widget=widgets[updates.id])?(null!=(ref=widget.instance)&&ref.destroy(),widget.instance=Widget(deserialize(updates.body)),isVisibleOnScreen(widget,screenId)?renderWidget(widget):void 0):void 0},renderWidget=function(widget){return contentEl.appendChild(widget.instance.render())},reRenderWidgets=function(){var _,results,shouldRender,widget;results=[];for(_ in widgets)widget=widgets[_],shouldRender=isVisibleOnScreen(widget,screenId),shouldRender&&!widget.instance.isRendered()?results.push(renderWidget(widget)):shouldRender?results.push(void 0):results.push(widget.instance.destroy());return results},hideWidget=function(widget){return widget.settings.hidden=!0,widget.instance.destroy()},unHideWidget=function(widget){return widget.settings.hidden=!1,isVisibleOnScreen(widget,screenId)?renderWidget(widget):void 0},handleBrokenWidget=function(id,details){var widget;return widget=widgets[id],widget.instance&&widget.instance.destroy(),console.error(details.error)},pinWidget=function(widget){return widget.settings.pinned=!0,reRenderWidgets()},unPinWidget=function(widget){return widget.settings.pinned=!1,reRenderWidgets()},deserialize=function(serializedWidget){return eval(serializedWidget)},isVisibleOnScreen=function(widgetDetails,theScreenId){return widgetDetails.settings.hidden?!1:widgetDetails.settings.screenId===theScreenId?!0:isMainScreen()&&(!widgetDetails.settings.screenId||!widgetDetails.settings.pinned&&-1===screens.indexOf(widgetDetails.settings.screenId))},isMainScreen=function(){return screenId===screens[0]},bail=function(){return window.location.reload(!0)},logError=function(serialized){var e,err,errors,i,len,results;try{for(errors=JSON.parse(serialized),results=[],i=0,len=errors.length;len>i;i++)err=errors[i],results.push(console.error(err));return results}catch(error){return e=error,console.error(serialized)}},window.onload=init},{"./src/listen":4,"./src/os_bridge.coffee":5,"./src/widget.coffee":6}],2:[function(require,module,exports){},{}],3:[function(require,module,exports){"use strict";function handleWSOpen(){open=!0,queuedMessages.forEach(function(data){ws.send(data)}),queuedMessages.length=0}function handleMessage(data){listeners.forEach(function(f){return f(data)})}var WebSocket="undefined"!=typeof window?window.WebSocket:require("ws"),ws=new WebSocket("ws://127.0.0.1:41415"),listeners=[],queuedMessages=[],open=!1;ws.on?(ws.on("open",handleWSOpen),ws.on("message",handleMessage)):(ws.onopen=handleWSOpen,ws.onmessage=function(e){return handleMessage(e.data)}),exports.onMessage=function(listener){listeners.push(listener)},exports.send=function(data){open?ws.send(data):queuedMessages.push(data)}},{ws:2}],4:[function(require,module,exports){"use strict";var ws=require("./SharedSocket"),listeners={};ws.onMessage(function(data){var message=JSON.parse(data);listeners[message.type]&&listeners[message.type].forEach(function(f){return f(message.payload)})}),module.exports=function(eventType,callback){listeners[eventType]||(listeners[eventType]=[]),listeners[eventType].push(callback)}},{"./SharedSocket":3}],5:[function(require,module,exports){var cachedWallpaper,getWallpaper,getWallpaperSlices,loadWallpaper,renderWallpaperSlice,renderWallpaperSlices;cachedWallpaper=new Image,window.addEventListener("onwallpaperchange",function(){var slices;return slices=getWallpaperSlices(),slices.length>0?loadWallpaper(function(wallpaper){return renderWallpaperSlices(wallpaper,slices)}):void 0}),exports.makeBgSlice=function(canvas){var ref;if(canvas=$(canvas),!(null!=(ref=canvas[0])?ref.getContext:void 0))throw new Error("no canvas element provided");return canvas.attr("data-bg-slice",!0),getWallpaper(function(wallpaper){return renderWallpaperSlice(wallpaper,canvas[0])})},getWallpaper=function(callback){return cachedWallpaper.loaded?callback(cachedWallpaper):(null==getWallpaper.callbacks&&(getWallpaper.callbacks=[]),getWallpaper.callbacks.push(callback),cachedWallpaper.loading?void 0:(cachedWallpaper.loading=!0,loadWallpaper(function(wallpaper){var i,len,ref;for(ref=getWallpaper.callbacks,i=0,len=ref.length;len>i;i++)(callback=ref[i])(wallpaper);return getWallpaper.callbacks.length=0,cachedWallpaper.loaded=!0})))},loadWallpaper=function(callback){return cachedWallpaper.onload=function(){return callback(cachedWallpaper)},cachedWallpaper.src=os.wallpaperUrl()},getWallpaperSlices=function(){return $("[data-bg-slice=true]")},renderWallpaperSlices=function(wallpaper,slices){var canvas,i,len,results;for(results=[],i=0,len=slices.length;len>i;i++)canvas=slices[i],results.push(renderWallpaperSlice(wallpaper,canvas));return results},renderWallpaperSlice=function(wallpaper,canvas){var ctx,height,left,rect,scale,top,width;return ctx=canvas.getContext("2d"),scale=window.devicePixelRatio/ctx.webkitBackingStorePixelRatio,rect=canvas.getBoundingClientRect(),canvas.width=rect.width*scale,canvas.height=rect.height*scale,left=Math.max(rect.left,0)*window.devicePixelRatio,top=Math.max(rect.top+22,0)*window.devicePixelRatio,width=Math.min(canvas.width,wallpaper.width-left),height=Math.min(canvas.height,wallpaper.height-top),ctx.drawImage(wallpaper,Math.round(left),Math.round(top),Math.round(width),Math.round(height),0,0,canvas.width,canvas.height)}},{}],6:[function(require,module,exports){module.exports=function(implementation){var api,contentEl,defaults,el,errorToString,init,loadScripts,mounted,publicApi,redraw,refresh,renderOutput,rendered,run,start,started,stop,timer;return api={},publicApi={},el=null,contentEl=null,timer=null,started=!1,rendered=!1,mounted=!1,defaults={id:"widget",refreshFrequency:1e3,render:function(output){return output},afterRender:function(){}},init=function(){var k,v;for(k in defaults)v=defaults[k],implementation[k]||(implementation[k]=v);for(k in publicApi)v=publicApi[k],implementation[k]||(implementation[k]=v);return api},api.render=function(){return el=document.createElement("div"),contentEl=document.createElement("div"),contentEl.id=implementation.id,contentEl.className="widget",el.innerHTML="<style>"+implementation.css+"</style>\n",el.appendChild(contentEl),start(),el},api.destroy=function(){return stop(),null!=el?(el.parentNode.removeChild(el),el=null,contentEl=null):void 0},api.domEl=function(){return el},api.isRendered=function(){return!!el},publicApi.start=start=function(){return started?void 0:(started=!0,null!=timer&&clearTimeout(timer),refresh())},publicApi.stop=stop=function(){return started?(started=!1,rendered=!1,null!=timer?clearTimeout(timer):void 0):void 0},publicApi.refresh=refresh=function(){var request;return null==implementation.command?redraw():(request=run(implementation.command,function(err,output){return started?redraw(err,output):void 0}),request.always(function(){return started&&implementation.refreshFrequency!==!1?timer=setTimeout(refresh,implementation.refreshFrequency):void 0}))},publicApi.run=run=function(command,callback){return $.ajax({url:"/run/",method:"POST",data:command,timeout:implementation.refreshFrequency,error:function(xhr){return callback(xhr.responseText||"error running command")},success:function(output){return callback(null,output)}})},redraw=function(error,output){var e;if(error)return contentEl.innerHTML=error,console.error(implementation.id+":",error),rendered=!1;try{return renderOutput(output)}catch(error1){return e=error1,contentEl.innerHTML=e.message,console.error(errorToString(e))}},renderOutput=function(output){return null!=implementation.update&&rendered?implementation.update(output,contentEl):(contentEl.innerHTML=implementation.render(output),loadScripts(contentEl),implementation.afterRender(contentEl),rendered=!0,null!=implementation.update?implementation.update(output,contentEl):void 0)},loadScripts=function(domEl){var i,len,ref,results,s,script;for(ref=domEl.getElementsByTagName("script"),results=[],i=0,len=ref.length;len>i;i++)script=ref[i],s=document.createElement("script"),s.src=script.src,results.push(domEl.replaceChild(s,script));return results},errorToString=function(err){var str;return str="["+implementation.id+"] "+(("function"==typeof err.toString?err.toString():void 0)||err.message),err.stack&&(str+="\n  in "+err.stack.split("\n")[0]+"()"),str},init()}},{}]},{},[1]);
